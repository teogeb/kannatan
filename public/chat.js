const PARTY_NAMES = {
    'kd': 'Kristillisdemokraatteja',
    'kesk': 'Keskustaa',
    'kok': 'Kokoomusta',
    'lib': 'Liberaalipuoluetta',
    'nyt': 'Liike Nytiä',
    'ps': 'Perussuomalaisia',
    'rkp': 'RKP:ta',
    'sdp': 'SDP:tä',
    'vas': 'Vasemmistoliittoa',
    'vihr': 'Vihreitä'
}

// generated by asking ChatGPT about the key topics for each party:
// "Listaa neljä politiikan asiaa, jotka ovat suomalaiselle [PUOLUEEN_NIMI]-puolueelle tärkeitä." 
const INITIAL_SUGGESTIONS = {
    'kd': ['perheet', 'palvelut', 'talous', 'koulutus'],
    'kesk': ['aluepolitiikka', 'yrittäjyys', 'perheet', 'asuminen'],
    'kok': ['talous', 'koulutus', 'vapaus', 'kilpailukyky'],
    'lib': ['vapaus', 'kaupungit', 'verotus', 'sosiaaliturva'],
    'nyt': ['demokratia', 'yrittäjyys', 'talous', 'hallinto'],
    'ps': ['maahanmuutto', 'itsenäisyys', 'talous', 'energia'],
    'rkp': ['kaksikielisyys', 'kansainvälisyys', 'ilmasto', 'yrittäjyys'],
    'sdp': ['hyvinvointivaltio', 'tasa-arvo', 'työllisyys', 'talous'],
    'vas': ['hyvinvointivaltio', 'oikeudenmukaisuus', 'ilmasto', 'työelämä'],
    'vihr': ['ilmasto', 'ihmisoikeudet', 'koulutus', 'kaupungit']
}

const ALLOWED_DOMAINS = [
    'kd.fi',
    'keskusta.fi',
    'kokoomus.fi',
    'liberaalipuolue.fi',
    'liikenyt.fi',
    'perussuomalaiset.fi',
    'sfp.fi',
    'sdp.fi',
    'vasemmisto.fi',
    'vihreat.fi',
    'aanestyspaikat.fi'
]

const initPage = () => {

    const urlSearchParams = new URLSearchParams(window.location.search)
    const partyId = urlSearchParams.get('partyId')
    const profileId = urlSearchParams.get('profileId')
    const profileImageElement = getChildElement('profileImage', document)
    const conversationContainer = document.getElementById('conversation')
    const questionInput = document.getElementById('question')
    const sendButton = document.getElementById('sendButton')
    let conversationId = undefined
    let latestUserAction = undefined

    const focusQuestionInput = () => {
        if (!isMobile()) {
            questionInput.focus()
        }
    }

    const createTextButton = (title, onClick) => {
        const btn = document.createElement('div')
        btn.classList.add('button')
        btn.textContent = _.capitalize(title)
        btn.onclick = () => {
            btn.classList.add('selected')
            focusQuestionInput()
            onClick()
        }
        return btn
    }

    const createImageButton = (iconId, onClick) => {
        const btn = document.createElement('div')
        btn.classList.add('button')
        btn.innerHTML = `<img src="/images/${iconId}.svg" class="icon"/>`
        btn.onclick = () => {
            btn.classList.add('selected')
            focusQuestionInput()
            onClick()
        }
        return btn
    }

    const scrollToConversationBottom = () => {
        conversationContainer.scrollTo({
            top: conversationContainer.scrollHeight,
            behavior: 'smooth'
        })
    }

    const addMessage = (text, sender, includeThumbs) => {
        const messageDiv = document.createElement('div')
        messageDiv.classList.add('message', sender)
        const contentAndThumbsDiv = document.createElement('div')
        contentAndThumbsDiv.classList.add('contentAndThumbs')
        const contentDiv = document.createElement('p')
        contentDiv.classList.add('content')
        contentDiv.innerHTML = withHtmlLinks(_.escape(text), ALLOWED_DOMAINS)
        contentAndThumbsDiv.appendChild(contentDiv)
        if (includeThumbs) {
            const thumbsDiv = document.createElement('div')
            thumbsDiv.classList.add('thumbs')
            const onThumbSelected = (text) => {
                latestUserAction = 'THUMB'
                sendMessage(text, false)
            }
            thumbsDiv.appendChild(createImageButton('thumb-up', () => onThumbSelected('Olen samaa mieltä')))
            thumbsDiv.appendChild(createImageButton('thumb-down', () => onThumbSelected('En ole samaa mieltä')))
            contentAndThumbsDiv.appendChild(thumbsDiv)
        }
        messageDiv.appendChild(contentAndThumbsDiv)
        if (sender === 'assistant') {
            const shortcutsDiv = document.createElement('div')
            shortcutsDiv.classList.add('shortcutsContainer')
            const shortcuts = document.createElement('div')
            shortcuts.classList.add('shortcuts')
            shortcutsDiv.appendChild(shortcuts)
            messageDiv.appendChild(shortcutsDiv)
        }
        conversationContainer.appendChild(messageDiv)
        conversationContainer.scrollTop = conversationContainer.scrollHeight
        return messageDiv
    }

    const createSuggestionButtons = (suggestions, areInitialSuggestions) => {
        let items = suggestions.map((s) => (
            {
                buttonTitle: s,
                message: s
            }
        ))
        if (areInitialSuggestions) {
            items.unshift({
                buttonTitle: 'Kunta- ja aluevaalit 2025',
                message: 'Kerro kuntavaaliohjelmasta ja kerro aluevaaliohjelmasta.'
            })
        } else {
            let extraShortcutCandidates  = []
            if (latestUserAction !== 'THUMB') {
                extraShortcutCandidates.push(_.sample([
                    { buttonTitle: 'Kerro lisää', message: 'Kerro lisää tästä aiheesta' },
                    { buttonTitle: 'Miksi?', message: 'Miksi?' },
                    { buttonTitle: 'Perustele', message: 'Kerro lisää tästä aiheesta, ja kerro miksi se on tärkeää' }
                ]))
            }
            extraShortcutCandidates.push(_.sample([
                { buttonTitle: 'Mitä muuta kannatat?', message: 'Mitä muuta kannatat? Vastaa minä-muodossa.' },
                { buttonTitle: 'Kerro muista tavoitteistasi', message: 'Kerro muista tavoitteista. Vastaa minä-muodossa.' },
                { buttonTitle: 'Mitä muuta pidätte tärkeänä?', message: 'Mitä muuta pidätte tärkeänä? Vastaa me-muodossa.' }
            ]))
            items = [
                ...extraShortcutCandidates,
                ...items
            ]
        }
        return items.map((item) => createTextButton(item.buttonTitle, () => {
            latestUserAction = 'SHORTCUT'
            sendMessage(item.message, false)
        }))
    }

    const sendMessage = async (text, showQuestion = true) => {
        const isFirstQuestion = (conversationId === undefined)
        if (showQuestion) {
            addMessage(text, 'user', false)
        }
        const messageDiv = addMessage('...', 'assistant', (latestUserAction !== 'THUMB'))
        messageDiv.classList.add('pending')
        const response = await sendApiRequest('chat', {
            question: text,
            partyId,
            profileId,
            conversationId
        })
        messageDiv.getElementsByTagName('p')[0].innerHTML = withHtmlLinks(_.escape(response.answer), ALLOWED_DOMAINS)
        messageDiv.classList.remove('pending')
        if (isFirstQuestion) {
            conversationId = response.conversationId
        }
        const suggestions = response.suggestions
        appendChildren(
            createSuggestionButtons(suggestions, false),
            getChildElement('shortcuts', messageDiv)
        )
        scrollToConversationBottom()
    }

    const sendQuestion = async () => {
        const question = questionInput.value.trim()
        if (question !== '') {
            latestUserAction = 'ASK'
            questionInput.value = ''
            sendMessage(question)
        }
    }

    const deleteThread = async (conversationId) => {
        await fetch('/api/deleteConversation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ conversationId })
        })
    }    

    profileImageElement.src = `/images/avatars/${partyId}-${profileId}.png`
    const initialMessageDiv = addMessage(`Hei! Olen tekoälyn luoma virtuaaliehdokas ja edustan ${PARTY_NAMES[partyId]}. Voit valita alta puolueemme ohjelmiin liittyvän teeman tai kysyä vapaasti - vastaan parhaani mukaan!` , 'assistant', false) 
    appendChildren(
        createSuggestionButtons(INITIAL_SUGGESTIONS[partyId], true),
        getChildElement('shortcuts', initialMessageDiv)
    )

    sendButton.addEventListener('click', () => {
        sendQuestion()
        focusQuestionInput()
    })
    questionInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            sendQuestion()
        }
    })
    window.addEventListener('resize', () => {
        scrollToConversationBottom()
    })
    window.addEventListener('beforeunload', () => {
        if (conversationId !== undefined)
            deleteThread(conversationId)
     })
}

document.addEventListener('DOMContentLoaded', () => initPage())
